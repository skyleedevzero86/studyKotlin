<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>AI Chat</title>
    <style>
        body {
            font-family: sans-serif;
            background: #f9f9f9;
            padding: 20px;
        }

        .chat-box {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 16px;
            height: 400px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 10px;
            white-space: pre-wrap;
        }

        .user {
            color: #1f78d1;
        }

        .bot {
            color: #2b9348;
        }

        form {
            max-width: 600px;
            margin: 10px auto 0;
            display: flex;
            gap: 8px;
        }

        input[type="text"] {
            flex: 1;
            padding: 8px;
            font-size: 16px;
        }

        button {
            padding: 8px 16px;
            font-size: 16px;
            background: #1f78d1;
            color: white;
            border: none;
            border-radius: 4px;
        }

        .loading {
            font-size: 14px;
            color: #888;
        }
    </style>
</head>
<body>
<h2>
    <span th:text="${aiChatRoom.id}"></span>Î≤à
    Ï±ÑÌåÖÎ∞©(<span th:text="${aiChatRoom.createDate}"></span>)
</h2>
<script th:inline="javascript">
    var chatRoomId = /*[[${aiChatRoom.id}]]*/ 0;
</script>
<div class="chat-box" id="chatBox"></div>

<form id="chatForm">
    <input
            type="text"
            id="messageInput"
            placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
            required
    />
    <button type="submit">Ï†ÑÏÜ°</button>
</form>

<script>
    const chatBox = document.getElementById("chatBox");
    const form = document.getElementById("chatForm");
    const input = document.getElementById("messageInput");

    async function loadExistingMessages() {
        try {
            const response = await fetch(`/ai/chat/${chatRoomId}/messages`);
            const messages = await response.json();

            messages.forEach((message) => {
                appendMessage("üßë", message.userMessage, "user");
                appendMessage("ü§ñ", message.botMessage, "bot");
            });

            chatBox.scrollTop = chatBox.scrollHeight;
        } catch (error) {
            console.error("Î©îÏãúÏßÄ Î°úÎî© Ï§ë Ïò§Î•ò Î∞úÏÉù:", error);
            appendMessage("‚ö†Ô∏è", "Í∏∞Ï°¥ Î©îÏãúÏßÄÎ•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.", "bot");
        }
    }

    loadExistingMessages();

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const userMessage = input.value.trim();
        if (!userMessage) return;

        appendMessage("üßë", userMessage, "user");

        const eventSource = new EventSource(`/ai/chat/generateStream/${chatRoomId}?userMessage=${encodeURIComponent(userMessage)}`);
        let botMsg = "";

        eventSource.onmessage = function (event) {
            const data = event.data;

            // Ï¢ÖÎ£å Î™ÖÎ†π Í∞êÏßÄ
            if (data.startsWith('"__EXIT__:')) {
                const cleanText = data.replace('"__EXIT__:', '').replace(/"$/, '');
                appendMessage("ü§ñ", cleanText, "bot");

                // ÏûÖÎ†•Ï∞ΩÍ≥º Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
                input.disabled = true;
                form.querySelector("button[type='submit']").disabled = true;

                eventSource.close();
                return;
            }

            if (data === "[DONE]") {
                appendMessage("ü§ñ", botMsg, "bot");
                eventSource.close();
            } else {
                const cleanData = data.replace(/^"|"$/g, "");
                botMsg += cleanData;
            }
        };

        input.value = "";
    });

    function appendMessage(sender, text, className) {
        const msgEl = document.createElement("div");
        msgEl.className = "message " + className;
        msgEl.textContent = `${sender}: ${text}`;
        chatBox.appendChild(msgEl);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
</body>
</html>
