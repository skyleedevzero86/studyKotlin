<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>AI Chat</title>
    <style>
        body { font-family: sans-serif; background: #f9f9f9; padding: 20px; }
        .chat-box {
            max-width: 600px; margin: 0 auto; background: white;
            border: 1px solid #ccc; border-radius: 8px; padding: 16px;
            height: 400px; overflow-y: auto;
        }
        .message { margin-bottom: 10px; white-space: pre-wrap; }
        .user { color: #1f78d1; }
        .bot { color: #2b9348; }
        form { max-width: 600px; margin: 10px auto 0; display: flex; gap: 8px; }
        input[type="text"] { flex: 1; padding: 8px; font-size: 16px; }
        button { padding: 8px 16px; font-size: 16px; background: #1f78d1; color: white; border: none; border-radius: 4px; }
    </style>
</head>
<body>
<h2>
    <span th:text="${aiChatRoom.id}"></span>ë²ˆ ì±„íŒ…ë°©
    (<span th:text="${aiChatRoom.createDate}"></span>)
</h2>
<script th:inline="javascript">
    var chatRoomId = /*[[${aiChatRoom.id}]]*/ 0;
</script>
<div class="chat-box" id="chatBox"></div>

<form id="chatForm">
    <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ìž…ë ¥í•˜ì„¸ìš”" required />
    <button type="submit">ì „ì†¡</button>
</form>

<script>
    const chatBox = document.getElementById("chatBox");
    const form = document.getElementById("chatForm");
    const input = document.getElementById("messageInput");

<<<<<<< Updated upstream
    async function loadExistingMessages() {
        try {
            const response = await fetch(`/ai/chat/${chatRoomId}/messages`);
            const messages = await response.json();

            messages.forEach((message) => {
                appendMessage("ðŸ§‘", message.userMessage, "user");
                appendMessage("ðŸ¤–", message.botMessage, "bot");
            });

            chatBox.scrollTop = chatBox.scrollHeight;
        } catch (error) {
            console.error("ë©”ì‹œì§€ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            appendMessage("âš ï¸", "ê¸°ì¡´ ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "bot");
        }
    }

    loadExistingMessages();

=======
>>>>>>> Stashed changes
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const userMessage = input.value.trim();
        if (!userMessage) return;
<<<<<<< Updated upstream

        appendMessage("ðŸ§‘", userMessage, "user");

        const eventSource = new EventSource(`/ai/chat/generateStream/${chatRoomId}?userMessage=${encodeURIComponent(userMessage)}`);
        let botMsg = "";

        eventSource.onmessage = function (event) {
            const data = event.data;

            // ì¢…ë£Œ ëª…ë ¹ ê°ì§€
            if (data.startsWith('"__EXIT__:')) {
                const cleanText = data.replace('"__EXIT__:', '').replace(/"$/, '');
                appendMessage("ðŸ¤–", cleanText, "bot");

                // ìž…ë ¥ì°½ê³¼ ë²„íŠ¼ ë¹„í™œì„±í™”
                input.disabled = true;
                form.querySelector("button[type='submit']").disabled = true;

                eventSource.close();
                return;
=======
        appendMessage("user", userMessage);
        input.value = "";

        const eventSource = new EventSource(`/ai/chat/generateStream/${chatRoomId}?userMessage=${encodeURIComponent(userMessage)}`);
        let botMessage = "";

        eventSource.onmessage = function (event) {
            if (event.data === "[DONE]") {
                appendMessage("bot", botMessage);
                eventSource.close();
            } else if (event.data.startsWith("__EXIT__:")) {
                appendMessage("bot", event.data.replace("__EXIT__:", ""));
                eventSource.close();
            } else {
                try {
                    const parsed = JSON.parse(event.data);
                    botMessage += parsed;
                } catch (e) {
                    botMessage += event.data.replace(/^"|"$/g, ''); // JSON ì—†ì´ ì˜¤ëŠ” ì¼ë°˜ í…ìŠ¤íŠ¸ ì²˜ë¦¬
                }
>>>>>>> Stashed changes
            }

<<<<<<< Updated upstream
            if (data === "[DONE]") {
                appendMessage("ðŸ¤–", botMsg, "bot");
                eventSource.close();
            } else {
                const cleanData = data.replace(/^"|"$/g, "");
                botMsg += cleanData;
            }
=======
        eventSource.onerror = function () {
            appendMessage("bot", "ðŸ¤– ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            eventSource.close();
>>>>>>> Stashed changes
        };
    });

    function appendMessage(role, text) {
        const div = document.createElement("div");
        div.className = "message " + role;
        div.textContent = `${role === "user" ? "ðŸ‘¤" : "ðŸ¤–"} ${text}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
</body>
</html>
