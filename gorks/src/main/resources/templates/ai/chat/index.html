<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>AI Chat</title>
    <style>
        body {
            font-family: sans-serif;
            background: #f9f9f9;
            padding: 20px;
        }

        .chat-box {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 16px;
            height: 400px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 10px;
            white-space: pre-wrap;
        }

        .user {
            color: #1f78d1;
        }

        .bot {
            color: #2b9348;
        }

        form {
            max-width: 600px;
            margin: 10px auto 0;
            display: flex;
            gap: 8px;
        }

        input[type="text"] {
            flex: 1;
            padding: 8px;
            font-size: 16px;
        }

        button {
            padding: 8px 16px;
            font-size: 16px;
            background: #1f78d1;
            color: white;
            border: none;
            border-radius: 4px;
        }

        .loading {
            font-size: 14px;
            color: #888;
        }
    </style>
</head>
<body>
<h2><span th:text="${aiChatRoom.id}"></span>ë²ˆ ì±„íŒ…ë°©</h2>
<script th:inline="javascript">
    var chatRoomId = /*[[${aiChatRoom.id}]]*/ 0;
</script>
<div class="chat-box" id="chatBox"></div>

<form id="chatForm">
    <input
            type="text"
            id="messageInput"
            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
            required
    />
    <button type="submit">ì „ì†¡</button>
</form>

<script>
    const chatBox = document.getElementById("chatBox");
    const form = document.getElementById("chatForm");
    const input = document.getElementById("messageInput");

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ë©”ì‹œì§€ ë¡œë”©
    async function loadExistingMessages() {
        try {
            const response = await fetch(`/ai/chat/${chatRoomId}/messages`);
            const messages = await response.json();

            messages.forEach((message) => {
                appendMessage(
                    "ğŸ§‘", message.userMessage, "user"
                );

                appendMessage(
                    "ğŸ¤–", message.botMessage, "bot"
                );
            });

            chatBox.scrollTop = chatBox.scrollHeight;
        } catch (error) {
            console.error("ë©”ì‹œì§€ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            appendMessage("âš ï¸", "ê¸°ì¡´ ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "bot");
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    loadExistingMessages();

    form.addEventListener("submit", function (e) {
        e.preventDefault();
        const message = input.value.trim();
        if (!message) return;

        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶œë ¥
        appendMessage("ğŸ§‘", message, "user");

        // SSE ì—°ê²°
        const url =
            `/ai/chat/generateStream/${chatRoomId}?message=` +
            encodeURIComponent(message);
        const eventSource = new EventSource(url);

        let botResponse = "";
        const loadingEl = document.createElement("div");
        loadingEl.className = "loading";
        loadingEl.textContent = "ğŸ¤– ì‘ë‹µ ì¤‘...";
        chatBox.appendChild(loadingEl);

        // ë´‡ ì‘ë‹µì„ ìœ„í•œ ë©”ì‹œì§€ ìš”ì†Œ ë¯¸ë¦¬ ìƒì„±
        const botMessageEl = document.createElement("div");
        botMessageEl.className = "message bot";
        botMessageEl.textContent = "ğŸ¤–: ";

        eventSource.onmessage = function (event) {
            if (event.data === "[DONE]") {
                eventSource.close();
                chatBox.removeChild(loadingEl);
            } else {
                if (!botMessageEl.parentNode) {
                    chatBox.appendChild(botMessageEl);
                }

                botResponse += event.data;
                botMessageEl.textContent = `ğŸ¤–: ${botResponse}`;
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        };


        eventSource.onerror = function (err) {
            eventSource.close();
            chatBox.removeChild(loadingEl);
            appendMessage("âš ï¸", "ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "bot");
        };

        input.value = "";
    });

    function appendMessage(sender, text, className) {
        const msgEl = document.createElement("div");
        msgEl.className = "message " + className;
        msgEl.textContent = `${sender}: ${text}`;
        chatBox.appendChild(msgEl);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
</body>
</html>
